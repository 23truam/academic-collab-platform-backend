<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.academic_collab_platform_backend.mapper.ChatMessageMapper">

    <select id="getChatHistory" resultType="com.example.academic_collab_platform_backend.model.ChatMessage">
        SELECT * FROM chat_messages 
        WHERE (sender_id = #{user1Id} AND receiver_id = #{user2Id}) 
           OR (sender_id = #{user2Id} AND receiver_id = #{user1Id})
        ORDER BY create_time DESC 
        LIMIT #{limit}
    </select>

    <select id="getChatHistoryBeforeTime" resultType="com.example.academic_collab_platform_backend.model.ChatMessage">
        SELECT * FROM chat_messages
        WHERE (
            (sender_id = #{user1Id} AND receiver_id = #{user2Id})
            OR (sender_id = #{user2Id} AND receiver_id = #{user1Id})
        )
        AND create_time &lt;= #{beforeTime}
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <select id="getChatHistoryAfterTime" resultType="com.example.academic_collab_platform_backend.model.ChatMessage">
        SELECT * FROM chat_messages
        WHERE (
            (sender_id = #{user1Id} AND receiver_id = #{user2Id})
            OR (sender_id = #{user2Id} AND receiver_id = #{user1Id})
        )
        AND create_time &gt; #{afterTime}
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <select id="getUnreadMessageCount" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM chat_messages 
        WHERE receiver_id = #{userId} AND is_read = FALSE
    </select>

    <select id="getUnreadCountMap" resultType="java.util.HashMap">
        SELECT sender_id, COUNT(*) as cnt
        FROM chat_messages
        WHERE receiver_id = #{currentUserId} AND is_read = FALSE
        GROUP BY sender_id
    </select>

    <update id="markMessagesAsRead">
        UPDATE chat_messages 
        SET is_read = TRUE 
        WHERE sender_id = #{senderId} AND receiver_id = #{receiverId} AND is_read = FALSE
    </update>

    <!-- 🆕 第二阶段：离线消息查询 -->
    <select id="getOfflineMessages" resultType="com.example.academic_collab_platform_backend.model.ChatMessage">
        SELECT id, sender_id, receiver_id, content, message_type, is_read, client_msg_id, create_time, update_time
        FROM chat_messages 
        WHERE receiver_id = #{userId}
          AND create_time > #{lastLogoutTime}
          AND is_read = false
        ORDER BY create_time ASC
        LIMIT #{limit}
    </select>

    <!-- 🆕 第三阶段：批量操作优化 -->
    <update id="batchMarkAsRead">
        UPDATE chat_messages 
        SET is_read = TRUE, update_time = NOW()
        WHERE receiver_id = #{userId} 
          AND id IN
        <foreach collection="messageIds" item="messageId" open="(" separator="," close=")">
            #{messageId}
        </foreach>
          AND is_read = FALSE
    </update>

    <select id="selectBatchByIds" resultType="com.example.academic_collab_platform_backend.model.ChatMessage">
        SELECT id, sender_id, receiver_id, content, message_type, is_read, client_msg_id, create_time, update_time
        FROM chat_messages 
        WHERE id IN
        <foreach collection="messageIds" item="messageId" open="(" separator="," close=")">
            #{messageId}
        </foreach>
        ORDER BY create_time ASC
    </select>

    <select id="countMessagesByTimeRange" resultType="java.lang.Integer">
        SELECT COUNT(*) 
        FROM chat_messages 
        WHERE receiver_id = #{userId}
          AND create_time BETWEEN #{startTime} AND #{endTime}
    </select>

</mapper> 